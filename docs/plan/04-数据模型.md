# 04 - 数据模型

## ER图

```
┌──────────────┐         ┌─────────────────┐
│     User     │1      n│   UserSettings  │
│──────────────│◄────────┤─────────────────│
│ Id (PK)      │         │ Id (PK)         │
│ Username     │         │ UserId (FK)     │
│ Email        │         │ Theme           │
│ PasswordHash │         │ Language        │
│ CreatedAt    │         │ NotifyEnabled   │
└──────┬───────┘         └─────────────────┘
       │1
       │
       │n
┌──────┴───────┐         ┌─────────────────┐
│   LiveRoom   │1      n│ DanmakuMessage  │
│──────────────│◄────────┤─────────────────│
│ Id (PK)      │         │ Id (PK)         │
│ UserId (FK)  │         │ RoomId (FK)     │
│ Platform     │         │ PlatformUserId  │
│ RoomId       │         │ Username        │
│ Title        │         │ Message         │
│ IsMonitoring │         │ Timestamp       │
└──────────────┘         └─────────────────┘
                                  │n
                                  │
                                  │1
                         ┌────────┴────────┐
                         │  PlatformUser   │
                         │─────────────────│
                         │ Id (PK)         │
                         │ PlatformId      │
                         │ Platform        │
                         │ Username        │
                         │ IsSuspicious    │
                         └─────────────────┘

┌──────────────┐         ┌─────────────────┐
│   Keyword    │         │ AnalysisReport  │
│──────────────│         │─────────────────│
│ Id (PK)      │         │ Id (PK)         │
│ UserId (FK)  │         │ UserId (FK)     │
│ Word         │         │ RoomId (FK)     │
│ Category     │         │ ReportData      │
│ IsRegex      │         │ GeneratedAt     │
└──────────────┘         └─────────────────┘
```

## 实体定义

### User (系统用户)

```csharp
public class User
{
    public Guid Id { get; set; }
    public string Username { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
    public string PasswordHash { get; set; } = string.Empty;
    public DateTime CreatedAt { get; set; }
    public DateTime? LastLoginAt { get; set; }
    
    // Navigation properties
    public UserSettings? Settings { get; set; }
    public ICollection<LiveRoom> LiveRooms { get; set; } = new List<LiveRoom>();
    public ICollection<Keyword> Keywords { get; set; } = new List<Keyword>();
    public ICollection<AnalysisReport> Reports { get; set; } = new List<AnalysisReport>();
}
```

### LiveRoom (直播间)

```csharp
public class LiveRoom
{
    public Guid Id { get; set; }
    public Guid UserId { get; set; }
    public string Platform { get; set; } = string.Empty; // "Bilibili", "Douyin"
    public string RoomId { get; set; } = string.Empty;
    public string Title { get; set; } = string.Empty;
    public bool IsMonitoring { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? LastMonitoredAt { get; set; }
    
    // Navigation properties
    public User User { get; set; } = null!;
    public ICollection<DanmakuMessage> Messages { get; set; } = new List<DanmakuMessage>();
}
```

### DanmakuMessage (弹幕消息)

```csharp
public class DanmakuMessage
{
    public Guid Id { get; set; }
    public Guid RoomId { get; set; }
    public string PlatformUserId { get; set; } = string.Empty;
    public string Username { get; set; } = string.Empty;
    public string Message { get; set; } = string.Empty;
    public DateTime Timestamp { get; set; }
    public string? Metadata { get; set; } // JSON格式的额外数据
    
    // Navigation properties
    public LiveRoom Room { get; set; } = null!;
}
```

### PlatformUser (平台用户)

```csharp
public class PlatformUser
{
    public Guid Id { get; set; }
    public string PlatformId { get; set; } = string.Empty;
    public string Platform { get; set; } = string.Empty;
    public string Username { get; set; } = string.Empty;
    public bool IsSuspicious { get; set; }
    public string? Tags { get; set; } // JSON格式标签
    public int MessageCount { get; set; }
    public DateTime FirstSeenAt { get; set; }
    public DateTime LastSeenAt { get; set; }
}
```

### Keyword (关键词)

```csharp
public class Keyword
{
    public Guid Id { get; set; }
    public Guid UserId { get; set; }
    public string Word { get; set; } = string.Empty;
    public string Category { get; set; } = string.Empty;
    public bool IsRegex { get; set; }
    public bool IsEnabled { get; set; }
    public DateTime CreatedAt { get; set; }
    
    // Navigation properties
    public User User { get; set; } = null!;
}
```

### UserSettings (用户设置)

```csharp
public class UserSettings
{
    public Guid Id { get; set; }
    public Guid UserId { get; set; }
    public string Theme { get; set; } = "light";
    public string Language { get; set; } = "zh-CN";
    public bool NotifyEnabled { get; set; }
    public string? NotifyEmail { get; set; }
    
    // Navigation properties
    public User User { get; set; } = null!;
}
```

### AnalysisReport (分析报告)

```csharp
public class AnalysisReport
{
    public Guid Id { get; set; }
    public Guid UserId { get; set; }
    public Guid? RoomId { get; set; }
    public string Title { get; set; } = string.Empty;
    public string ReportData { get; set; } = string.Empty; // JSON格式
    public DateTime StartTime { get; set; }
    public DateTime EndTime { get; set; }
    public DateTime GeneratedAt { get; set; }
    
    // Navigation properties
    public User User { get; set; } = null!;
    public LiveRoom? Room { get; set; }
}
```

---

**文档版本**: v1.0  
**创建日期**: 2026-01-04
