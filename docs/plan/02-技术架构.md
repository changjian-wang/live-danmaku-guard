# 02 - 技术架构

## 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层 (Client)                         │
├─────────────────────────────────────────────────────────────────┤
│  Web浏览器                │         Electron桌面客户端           │
│  (Chrome, Safari, etc)    │         (Windows, macOS, Linux)      │
└────────────┬─────────────┴───────────────────┬──────────────────┘
             │                                 │
             │         Vue 3 + TypeScript      │
             │         Naive UI + ECharts      │
             │         Pinia + Vue Router      │
             │                                 │
┌────────────┴─────────────────────────────────┴──────────────────┐
│                         接口层 (API)                             │
├─────────────────────────────────────────────────────────────────┤
│  REST API (ASP.NET Core)  │  SignalR WebSocket (实时通信)      │
│  - 认证授权 (JWT)         │  - 弹幕实时推送                     │
│  - 业务接口               │  - 状态通知                         │
│  - Swagger文档            │  - 双向通信                         │
└────────────┬─────────────┴───────────────────┬──────────────────┘
             │                                 │
┌────────────┴─────────────────────────────────┴──────────────────┐
│                         业务层 (Business)                        │
├─────────────────────────────────────────────────────────────────┤
│  认证服务    │  平台对接服务  │  分析服务    │  报告服务        │
│  - 用户管理  │  - Bilibili    │  - 水军识别  │  - Excel导出     │
│  - JWT生成   │  - 抖音        │  - 数据统计  │  - PDF生成       │
│  - 权限控制  │  - 协议解析    │  - 行为分析  │  - 模板管理      │
└────────────┬─────────────────────────────────┬──────────────────┘
             │                                 │
┌────────────┴─────────────────────────────────┴──────────────────┐
│                         数据层 (Data)                            │
├─────────────────────────────────────────────────────────────────┤
│  Entity Framework Core    │    SQLite 数据库                    │
│  - Repository模式         │    - 用户数据                       │
│  - 数据迁移               │    - 弹幕记录                       │
│  - 查询优化               │    - 分析结果                       │
└─────────────────────────────────────────────────────────────────┘
```

## 2.2 技术选型

### 前端技术栈

| 技术 | 版本 | 用途 | 选择理由 |
|------|------|------|---------|
| **Vue 3** | 3.4+ | 前端框架 | 响应式、组合式API、TypeScript支持好 |
| **TypeScript** | 5.4+ | 类型系统 | 类型安全、代码提示、降低bug率 |
| **Vite** | 5.2+ | 构建工具 | 快速开发、HMR、ESM支持 |
| **Naive UI** | 2.38+ | UI组件库 | 设计精美、组件丰富、TypeScript友好 |
| **ECharts** | 5.5+ | 数据可视化 | 功能强大、图表丰富、性能优秀 |
| **Pinia** | 2.1+ | 状态管理 | Vue 3官方推荐、简洁API |
| **Vue Router** | 4.3+ | 路由管理 | Vue官方路由、支持动态路由 |
| **Axios** | 1.6+ | HTTP客户端 | Promise based、拦截器支持 |
| **SignalR Client** | 8.0+ | 实时通信 | 与后端SignalR配套 |
| **TailwindCSS** | 3.4+ | CSS框架 | 原子化CSS、快速开发 |
| **Electron** | 29.0+ | 桌面客户端 | 跨平台、Web技术栈 |

### 后端技术栈

| 技术 | 版本 | 用途 | 选择理由 |
|------|------|------|---------|
| **.NET** | 8.0 | 运行时 | 高性能、跨平台、长期支持 |
| **ASP.NET Core** | 8.0 | Web框架 | 成熟稳定、性能优秀 |
| **SignalR** | 8.0 | 实时通信 | 原生支持、易于集成 |
| **EF Core** | 8.0 | ORM | 对象关系映射、代码优先 |
| **SQLite** | - | 数据库 | 轻量级、无需安装、易部署 |
| **JWT Bearer** | 8.0 | 认证 | 无状态、标准化、安全 |
| **BCrypt** | 4.0+ | 密码加密 | 安全性高、抗暴力破解 |
| **Serilog** | 4.0+ | 日志 | 结构化日志、丰富的Sink |
| **Swagger** | - | API文档 | 自动生成、交互式测试 |
| **xUnit** | - | 单元测试 | .NET社区标准 |

### 开发工具

| 工具 | 用途 |
|------|------|
| **Visual Studio 2022 / VS Code** | IDE |
| **Postman / Swagger UI** | API测试 |
| **Git / GitHub** | 版本控制 |
| **Docker / Docker Compose** | 容器化部署 |

## 2.3 项目结构

### 后端结构 (src/backend/)

```
src/backend/
├── LiveDanmakuGuard.sln                    # 解决方案文件
├── LiveDanmakuGuard.Api/                   # Web API 项目
│   ├── Controllers/                        # API控制器
│   │   ├── AuthController.cs              # 认证接口
│   │   ├── RoomController.cs              # 直播间管理
│   │   └── HealthController.cs            # 健康检查
│   ├── Hubs/                              # SignalR Hubs
│   │   └── DanmakuHub.cs                  # 弹幕实时推送
│   ├── BackgroundServices/                # 后台服务
│   │   └── DanmakuMonitorService.cs       # 弹幕监控服务
│   ├── Program.cs                         # 应用入口
│   ├── appsettings.json                   # 配置文件
│   └── LiveDanmakuGuard.Api.csproj        # 项目文件
├── LiveDanmakuGuard.Core/                 # 核心业务逻辑
│   ├── Entities/                          # 实体类
│   ├── DTOs/                              # 数据传输对象
│   ├── Interfaces/                        # 接口定义
│   └── Services/                          # 业务服务
├── LiveDanmakuGuard.Auth/                 # 认证授权
│   ├── Services/                          # 认证服务
│   │   ├── JwtService.cs                  # JWT令牌服务
│   │   └── PasswordService.cs             # 密码服务
│   └── Models/                            # 认证模型
├── LiveDanmakuGuard.Platforms/            # 平台对接
│   ├── Abstractions/                      # 抽象接口
│   │   └── IPlatformClient.cs             # 平台客户端接口
│   ├── Bilibili/                          # B站实现
│   │   ├── BilibiliClient.cs              # B站客户端
│   │   └── BilibiliMessageParser.cs       # 消息解析
│   └── Douyin/                            # 抖音实现(待开发)
├── LiveDanmakuGuard.Data/                 # 数据访问层
│   ├── AppDbContext.cs                    # 数据库上下文
│   ├── Migrations/                        # 数据库迁移
│   └── Repositories/                      # 仓储实现
└── LiveDanmakuGuard.Tests/                # 单元测试
    ├── UnitTests/                         # 单元测试
    └── IntegrationTests/                  # 集成测试
```

### 前端结构 (src/frontend/live-danmaku-guard-web/)

```
src/frontend/live-danmaku-guard-web/
├── package.json                           # 依赖配置
├── vite.config.ts                         # Vite配置
├── tsconfig.json                          # TypeScript配置
├── tailwind.config.js                     # TailwindCSS配置
├── index.html                             # HTML入口
├── electron/                              # Electron配置
│   ├── main.js                            # 主进程
│   └── preload.js                         # 预加载脚本
└── src/
    ├── main.ts                            # 应用入口
    ├── App.vue                            # 根组件
    ├── assets/                            # 静态资源
    │   └── styles/                        # 样式文件
    ├── components/                        # 组件
    │   ├── common/                        # 通用组件
    │   ├── danmaku/                       # 弹幕组件
    │   ├── user/                          # 用户组件
    │   ├── charts/                        # 图表组件
    │   └── room/                          # 直播间组件
    ├── views/                             # 页面视图
    │   ├── Dashboard.vue                  # 仪表板
    │   ├── RoomMonitor.vue                # 直播间监控
    │   └── UserAnalysis.vue               # 用户分析
    ├── stores/                            # Pinia状态管理
    │   ├── auth.ts                        # 认证状态
    │   ├── room.ts                        # 直播间状态
    │   └── danmaku.ts                     # 弹幕状态
    ├── services/                          # 服务层
    │   ├── api.ts                         # API客户端
    │   └── signalr.ts                     # SignalR客户端
    ├── router/                            # 路由配置
    │   └── index.ts                       # 路由定义
    ├── composables/                       # 组合式函数
    ├── types/                             # TypeScript类型
    └── utils/                             # 工具函数
```

## 2.4 模块职责

### API层职责

- 接收HTTP请求，参数验证
- 调用业务层服务处理请求
- 返回统一格式的响应
- 异常处理和日志记录
- SignalR连接管理和消息推送

### 业务层职责

- 实现核心业务逻辑
- 调用数据层进行数据操作
- 处理业务规则和验证
- 事件发布和订阅
- 缓存管理

### 数据层职责

- 数据库操作封装
- 实体映射和查询
- 事务管理
- 数据迁移

### 平台层职责

- 平台协议实现
- WebSocket连接管理
- 消息接收和解析
- 心跳保持
- 断线重连

## 2.5 通信机制

### REST API

- 用于常规的CRUD操作
- 遵循RESTful设计原则
- 使用JWT进行身份验证
- 统一的响应格式

### SignalR WebSocket

- 用于实时数据推送
- 弹幕消息实时推送
- 状态更新通知
- 支持双向通信

### 平台WebSocket

- 连接直播平台服务器
- 接收弹幕、礼物等消息
- 维持心跳连接
- 处理断线重连

## 2.6 安全设计

### 认证授权

- JWT Token认证
- Token刷新机制
- 角色权限控制
- 密码BCrypt加密

### 数据安全

- SQL注入防护(EF Core参数化)
- XSS防护(输入验证)
- CSRF防护(Token验证)
- HTTPS传输加密

### 接口安全

- 请求频率限制
- IP黑白名单
- 参数验证
- 日志审计

---

**文档版本**: v1.0  
**创建日期**: 2026-01-04  
**最后更新**: 2026-01-04
